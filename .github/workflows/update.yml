name: ğŸ”„ Auto Update Flake Inputs

on:
  schedule:
    # æ¯å‘¨å›› UTC 02:30 æ‰§è¡Œ
    - cron: '30 2 * * 4'
  workflow_dispatch:

jobs:
  update-flake:
    name: ğŸ› ï¸ Update & Test Flake
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4 # å‡çº§åˆ° v4
        with:
          fetch-depth: 0

      - name: â„ï¸ Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            extra-experimental-features = nix-command flakes
            allow-import-from-derivation = true

      - name: ğŸ¤– Prepare GitHub Bot
        run: |
          git config --local user.email "flakebot@users.noreply.github.com"
          git config --local user.name "flakebot"

      - name: ğŸ”„ Update Flake Inputs
        id: update
        run: |
          old_hash=$(sha256sum flake.lock)
          nix flake update --commit-lock-file
          new_hash=$(sha256sum flake.lock)
          
          if [ "$old_hash" != "$new_hash" ]; then
            echo "CHANGED=true" >> $GITHUB_ENV
            echo "âœ¨ Flake inputs updated."
          else
            echo "CHANGED=false" >> $GITHUB_ENV
            echo "ğŸ˜´ No updates found."
          fi

      - name: ğŸ§ª Test Build
        if: env.CHANGED == 'true'
        run: |
          echo "ğŸ”¨ Testing build for pragma-sevka-mono.nerd..."
          nix build .#pragma-sevka-mono.nerd --print-build-logs

      - name: â¬†ï¸ Push Changes
        if: env.CHANGED == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
          force: false # é™¤éå¿…è¦ï¼Œå¦åˆ™å»ºè®®å…³é—­ force ä»¥é˜²æ„å¤–è¦†ç›–

      - name: âœ… Done
        if: env.CHANGED == 'false'
        run: echo "No changes to push. Workflow finished."
