name: ğŸš€ Font Merger Pro
on:
  schedule:
    - cron: "0 0 * * 5" 
  workflow_dispatch:

env:
  FUSION_COPYRIGHT: Copyright 2025 Albert (${{ github.server_url }}/${{ github.repository }})
  FUSION_DESCRIPTION: "The free and open-source font fused with Iosevka and LXGW WenKai"
  FUSION_DEVELOPER: lyeli
  FUSION_LICENSE: "This Font Software is licensed under the SIL Open Font License, Version 1.1. This license is available with a FAQ at: https://openfontlicense.org"
  IOSEVKA_COPYRIGHT: Copyright 2015-2025, Renzhi Li (aka. Belleve Invis, belleve@typeof.net).
  LXGW_COPYRIGHT: Copyright 2021-2024 LXGW (https://github.com/lxgw/LxgwWenKai-Lite) Copyright 2020 The Klee Project Authors (https://github.com/fontworks-fonts/Klee)
  FAMILY: "Pragma Sevka SC"
  FAMILY_NAME: "Pragma-Sevka-SC"
  FAMILY_NF: "Pragma Sevka SC NF"
  FAMILY_NF_NAME: "Pragma-Sevka-SC-NF"

jobs:
  merge-process:
    name: ğŸ› ï¸ åˆå¹¶å¹¶ä¼˜åŒ–å­—ä½“
    runs-on: ubuntu-latest
    # å°† RUN_BUILD åˆå§‹åŒ–é€»è¾‘ç§»å…¥ stepsï¼Œé¿å…ç¯å¢ƒå˜é‡æ±¡æŸ“
    steps:
      - name: ğŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            extra-experimental-features = nix-command flakes
            allow-import-from-derivation = true
        
      - name: Prepare github bot
        run: |
          git config --local user.email "flakebot@users.noreply.github.com"
          git config --local user.name "flakebot"

      - name: Update source and check status
        id: check_status
        run: |
          old_commit=$(git rev-parse --short=7 HEAD)
          cat > secrets.toml <<EOF
          [keys]
          github = "${{ secrets.GITHUB_TOKEN }}"
          EOF
          nix run .#upnvfetcher
          if [[ "$(git rev-parse --short=7 HEAD)" != "$old_commit" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
             echo "RUN_BUILD=true" >> $GITHUB_ENV
          fi

      - name: Get latest tag
        if: env.RUN_BUILD == 'true'
        run: |
          LOCAL_TAG=$(jq -r '.iosevka.version' _sources/generated.json)
          LATEST_TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          [[ "$LATEST_TAG" == "$LOCAL_TAG" ]] && TAG_NAME="${LOCAL_TAG}-$(date +%s)" || TAG_NAME="$LOCAL_TAG"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      - name: Build and Download Fonts
        if: env.RUN_BUILD == 'true'
        run: |
          nix run .#ci
          lxgw_tag=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/lxgw/LxgwWenKai/releases/latest | jq -r .tag_name)
          lxgw_lite_tag=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/lxgw/LxgwWenKai-Lite/releases/latest | jq -r .tag_name)
          
          wget -q "https://github.com/lxgw/LxgwWenKai/releases/download/${lxgw_tag}/LXGWWenKaiMono-Regular.ttf"
          wget -q "https://github.com/lxgw/LxgwWenKai-Lite/releases/download/${lxgw_lite_tag}/LXGWWenKaiMonoLite-Regular.ttf"
          
          unzip -o ./dist/pragma-sevka-mono.zip
          unzip -o ./dist/pragma-sevka-mono-nerd.zip
          echo "LXGW_VERSION=$lxgw_tag" >> $GITHUB_ENV

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: sudo apt update && sudo apt install -y fontforge python3-fontforge python3-fonttools p7zip jq gftools ttfautohint

      - name: ğŸ—ï¸ æ‰§è¡Œå­—ä½“åˆå¹¶è„šæœ¬
        if: env.RUN_BUILD == 'true'
        run: |
          mkdir -p output
          # åˆå¹¶æ ‡å‡†ç‰ˆ, ä¸å»ºè®®ä½¿ç”¨è¿›è¡Œ hintï¼Œå®ƒä¼šå¯¼è‡´å­—ä½“æ•°æ®ç¿»å€
          python tools/run.py -b ./TTF/pragma-sevka-mono-normalregularupright.ttf \
            -z ./LXGWWenKaiMono-Regular.ttf ./LXGWWenKaiMonoLite-Regular.ttf \
            -f "${{ env.FAMILY }}" -s "Regular" -o "output/${{ env.FAMILY_NAME }}-Regular.ttf" \
            -w 500 525 1000 1050 -x 525 -l -50 -t 50 -a 1050
          
          # åˆå¹¶ NF ç‰ˆ
          python tools/run.py -b ./PragmaSevkaMonoNerdFontMono-Regular.ttf \
            -z ./LXGWWenKaiMono-Regular.ttf ./LXGWWenKaiMonoLite-Regular.ttf \
            -f "${{ env.FAMILY_NF }}" -s "Regular" -o "output/${{ env.FAMILY_NF_NAME }}-Regular.ttf" \
            -w 500 525 1000 1050 -x 525 -l -50 -t 50 -a 1050
        
      - name: ğŸ–‹ï¸ Update font metadata
        if: env.RUN_BUILD == 'true'
        run: |
          NOW="v$(TZ='Asia/Shanghai' date +'%Y%m%d.%H%M%S')"
          for font_path in "output/${{ env.FAMILY_NAME }}-Regular.ttf" "output/${{ env.FAMILY_NF_NAME }}-Regular.ttf"; do
            is_nf=""
            [[ "$font_path" == *"-NF-"* ]] && is_nf=" NF"
            
            gftools update-nameids "$font_path" \
              --uniqueid "${{ env.FAMILY }}$is_nf Regular $NOW" \
              --designer "$FUSION_DEVELOPER" \
              --manufacturer "$FUSION_DEVELOPER" \
              --version "$NOW; Iosevka ${{env.TAG_NAME}}; LXGW_WenKai ${{ env.LXGW_VERSION }}" \
              --copyright "$(printf "$IOSEVKA_COPYRIGHT\n$LXGW_COPYRIGHT\n$FUSION_COPYRIGHT")" \
              --license "$FUSION_LICENSE"
            mv "$font_path.fix" "$font_path"
          done

      - name: ğŸ“Š Generate artifact info
        if: env.RUN_BUILD == 'true'
        run: |
          {
            echo 'fontinfo<<EOF'
            git log -1 --oneline
            echo ""
            echo "* PragmaSevkaMonoNerdFontMono-Regular.ttf:"
            python tools/infos_font.py ./PragmaSevkaMonoNerdFontMono-Regular.ttf

            echo ""
            echo "* pragma-sevka-mono-normalregularupright.ttf:"
            python tools/infos_font.py ./TTF/pragma-sevka-mono-normalregularupright.ttf 

            echo ""
            echo "* LXGWWenKaiMono-Regular.ttf:"
            python tools/infos_font.py ./LXGWWenKaiMono-Regular.ttf

            for i in ./output/*; do
              echo ""
              echo "* $(basename $i)"
              python tools/infos_font.py $i
            done
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: ğŸš€ Release
        if: env.RUN_BUILD == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./dist/*.zip
            ./output/*.ttf
            # ./dist/*.zip
            # # ./dist/pragma-sevka-mono-nerd.zip
            # # ./dist/pragma-sevka-mono.zip
            # # ./dist/pragma-sevka-serif.zip
            # # ./dist/pragma-sevka-sans.zip
            # ./output/*.ttf
            # # ./output/Pragma-Sevka-SC-Regular.ttf
            # # ./output/Pragma-Sevka-SC-NF-Regular.ttf
          tag_name: ${{ env.TAG_NAME }}
          name: "Release ${{ env.TAG_NAME }}"
          body: ${{ env.fontinfo }}
          draft: ${{ github.event_name == 'workflow_dispatch' && true || false }}
